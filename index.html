<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <title>加药加氯计算器</title>
</head>

<body>
    <h1>加药加氯计算器</h1>

    <p>输入当前运行系列（例如：1、2、3、4、5、6）</p>
    <input type="number" id="series">

    <p>输入当前进水量（m³/h）</p>
    <input type="number" id="flow">

    <p>输入目标余氯（mg/L）</p>
    <input type="number" id="cl">

    <p>输入有效氯含量（%）</p>
    <input type="number" id="rate">

    <p>输入次氯酸钠密度（kg/L）</p>
    <input type="number" id="density">

    <p>输入当前加药泵频率（Hz）</p>
    <input type="number" id="hz">

    <p>输入加药泵最大流量（L/h）</p>
    <input type="number" id="maxflow">

    <p>输入加药泵最大频率（Hz）</p>
    <input type="number" id="maxhz">

    <br><br>
    <button onclick="calc()">计算</button>

    <h2>计算结果</h2>
    <p id="result"></p>

    <hr>

    <h2>历史记录</h2>
    <textarea id="past" rows="10" cols="40" readonly></textarea>

    <script>
        const dbName = "cal_tools_db"
        const storeName = "data"
        let db

        const fields = [
            "series",
            "flow",
            "cl",
            "rate",
            "density",
            "hz",
            "maxflow",
            "maxhz",
            "past"
        ]

        function openDB(callback) {
            const request = indexedDB.open(dbName, 1)

            request.onupgradeneeded = function (e) {
                db = e.target.result
                if (!db.objectStoreNames.contains(storeName)) {
                    db.createObjectStore(storeName)
                }
            }

            request.onsuccess = function (e) {
                db = e.target.result
                callback && callback()
            }
        }

        function saveData(key, value) {
            const tx = db.transaction(storeName, "readwrite")
            const store = tx.objectStore(storeName)
            store.put(value, key)
        }

        function loadData(key, callback) {
            const tx = db.transaction(storeName, "readonly")
            const store = tx.objectStore(storeName)
            const req = store.get(key)
            req.onsuccess = () => callback(req.result)
        }

        // 自动恢复
        openDB(function () {
            fields.forEach(id => {
                loadData(id, val => {
                    if (val !== undefined && id !== "past") {
                        document.getElementById(id).value = val
                    }
                    if (id === "past" && val !== undefined) {
                        document.getElementById("past").value = val
                    }
                })
            })
        })

        // 自动保存
        document.addEventListener("input", function (e) {
            if (fields.includes(e.target.id)) {
                saveData(e.target.id, e.target.value)
            }
        })

        function calc() {
            let series = Number(document.getElementById("series").value)
            let flow = Number(document.getElementById("flow").value)
            let cl = Number(document.getElementById("cl").value)
            let rate = Number(document.getElementById("rate").value) / 100
            let density = Number(document.getElementById("density").value)
            let hz = Number(document.getElementById("hz").value)
            let maxflow = Number(document.getElementById("maxflow").value)
            let maxhz = Number(document.getElementById("maxhz").value)

            // ⚠️ 计算公式：完全未改
            let dosage = flow * cl * 3.6 / rate / density / series
            let newhz = dosage / maxflow * maxhz

            let res = `
单系列加药量：${dosage.toFixed(2)} L/h
推荐泵频率：${newhz.toFixed(2)} Hz
            `

            document.getElementById("result").innerText = res

            let past = document.getElementById("past").value
            let newPast =
                `进水量:${flow}  余氯:${cl}  系列:${series} → ${newhz.toFixed(2)}Hz\n` + past

            document.getElementById("past").value = newPast
            saveData("past", newPast)
        }
    </script>

</body>

</html>