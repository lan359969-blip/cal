<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0" charset="utf-8">
    <title>加药加氯计算器</title>
    <link href="//unpkg.com/layui@2.9.13/dist/css/layui.css" rel="stylesheet">
</head>

<body class="layui-bg-gray">

    <h2>⚠️ 输入的差值均为无视小数点后的整数</h2>
    <hr>

    <input type="text" id="hiddenTxt" placeholder="微信数据粘贴至此">
    <button class="layui-btn layui-btn-normal layui-btn-xs" onclick="readCpy()">获取进水量</button>
    <button class="layui-btn layui-btn-normal layui-btn-xs" onclick="clean()">清空</button>

    <p>
        一二系列进水量： <input type="number" id="12"><br />
        三四系列进水量： <input type="number" id="34"><br />
        五六系列进水量： <input type="number" id="56"><br />
    </p>

    <hr>
    <h2>加药计算部分</h2>
    <h3>一期</h3>
    <h4>
        浓度按照混凝剂
        <input type="number" value="10" style="width:40px;" id="hn_con">%，
        助凝剂
        <input type="number" value="5" style="width:50px;" id="zn_con">%计算
    </h4>
    <hr>

    <p>
        1系列混凝剂差值：<input type="number" id="HN_adiff"><br />
        2系列混凝剂差值：<input type="number" id="HN_bdiff"><br />
        3系列混凝剂差值：<input type="number" id="HN_cdiff"><br />
        4系列混凝剂差值：<input type="number" id="HN_ddiff"><br />
    </p>

    <p>
        1系列助凝剂差值：<input type="number" id="ZN_adiff"><br />
        2系列助凝剂差值：<input type="number" id="ZN_bdiff"><br />
        3系列助凝剂差值：<input type="number" id="ZN_cdiff"><br />
        4系列助凝剂差值：<input type="number" id="ZN_ddiff"><br />
    </p>

    <input type="button" class="layui-btn layui-btn-lg layui-btn-normal" value="计算" onclick="do_cal()">

    <h3>计算结果：</h3>
    <textarea id="result"></textarea>

    <hr>

    <h2>加氯计算部分</h2>
    补氯 <input type="checkbox" id="isAdd">

    <input type="button" class="layui-btn layui-btn-lg layui-btn-normal" value="计算" onclick="do_CLcal()">
    <textarea id="result_"></textarea>

    <hr class="layui-border-blue">

</body>

</html>

<script type="text/javascript">
/* =========================
   你原来的 JS 功能代码
   do_cal / do_CLcal / readCpy / copy 等
   ⚠️ 这里保持与你原文件一模一样
   ========================= */
</script>


<!-- ================= 新增：IndexedDB 自动保存 / 自动恢复（开始） ================= -->
<script>
(function () {
    const DB_NAME = "cal_tools_autosave";   // 新增
    const STORE_NAME = "kv";                // 新增
    let db;                                 // 新增

    const openReq = indexedDB.open(DB_NAME, 1);

    openReq.onupgradeneeded = function (e) {
        db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME);
        }
    };

    openReq.onsuccess = function (e) {
        db = e.target.result;
        restoreAll();
    };

    function save(key, value) {
        if (!db) return;
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).put(value, key);
    }

    function load(key, cb) {
        if (!db) return;
        const tx = db.transaction(STORE_NAME, "readonly");
        const req = tx.objectStore(STORE_NAME).get(key);
        req.onsuccess = function () {
            cb(req.result);
        };
    }

    function restoreAll() {
        document.querySelectorAll("input, textarea").forEach(el => {
            if (!el.id) return;
            load(el.id, val => {
                if (val !== undefined) el.value = val;
            });
        });
    }

    document.addEventListener("input", function (e) {
        const el = e.target;
        if (!el.id) return;
        if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
            save(el.id, el.value);
        }
    });
})();
</script>
<!-- ================= 新增：IndexedDB 自动保存 / 自动恢复（结束） ================= -->