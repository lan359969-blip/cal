<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0" charset="utf-8">
    <title>加药加氯计算器</title>
    <link href="//unpkg.com/layui@2.9.13/dist/css/layui.css" rel="stylesheet">

    <style>
        body { margin:0; padding:12px; font-family:-apple-system,BlinkMacSystemFont; background:#f4f5f7; }
        .module,section,div { background:#fff; border-radius:14px; padding:14px; margin-bottom:16px; }
        button { width:100%; height:44px; border-radius:10px; font-size:16px; }
        input,textarea { width:100%; height:40px; font-size:16px; }
    </style>
</head>

<body class="layui-bg-gray">

<h2>⚠️ 输入的差值均为无视小数点后的整数</h2>
<hr>

<input type="text" id="hiddenTxt" placeholder="微信数据粘贴至此">
<button class="layui-btn layui-btn-normal layui-btn-xs" onclick="readCpy()">获取进水量</button>
<button class="layui-btn layui-btn-normal layui-btn-xs" onclick="clean()">清空</button>

<p>
    一二系列进水量： <input type="number" id="12"><br />
    三四系列进水量： <input type="number" id="34"><br />
    五六系列进水量： <input type="number" id="56"><br />
</p>

<hr>

<h2>加药计算部分</h2>
<h3>一期</h3>
<h4>
    浓度按照混凝剂<input type="number" value="10" style="width:40px" id="hn_con">%，
    助凝剂<input type="number" value="5" style="width:50px" id="zn_con">%
</h4>

<p>
    1系列混凝剂差值：<input type="number" id="HN_adiff"><br />
    2系列混凝剂差值：<input type="number" id="HN_bdiff"><br />
    3系列混凝剂差值：<input type="number" id="HN_cdiff"><br />
    4系列混凝剂差值：<input type="number" id="HN_ddiff"><br />
</p>

<p>
    1系列助凝剂差值：<input type="number" id="ZN_adiff"><br />
    2系列助凝剂差值：<input type="number" id="ZN_bdiff"><br />
    3系列助凝剂差值：<input type="number" id="ZN_cdiff"><br />
    4系列助凝剂差值：<input type="number" id="ZN_ddiff"><br />
</p>

<h3>二期</h3>
<h4>
    浓度按照混凝剂<input type="number" value="10" style="width:40px" id="hn_con2">%，
    助凝剂<input type="number" value="5" style="width:50px" id="zn_con2">%
</h4>

<input type="number" id="HN_ediff1"> 5-1混凝剂<br />
<input type="number" id="HN_ediff2"> 5-2混凝剂<br />
<input type="number" id="HN_fdiff1"> 6-1混凝剂<br />
<input type="number" id="HN_fdiff2"> 6-2混凝剂<br />

<br>

<input type="number" id="ZN_ediff1"> 5-1助凝剂<br />
<input type="number" id="ZN_ediff2"> 5-2助凝剂<br />
<input type="number" id="ZN_fdiff1"> 6-1助凝剂<br />
<input type="number" id="ZN_fdiff2"> 6-2助凝剂<br />

<input type="button" class="layui-btn layui-btn-lg layui-btn-normal" value="计算" onclick="do_cal()">

<h3>计算结果：</h3>
<textarea id="result"></textarea>
<button onclick="copy()">复制到剪贴板</button>

<hr>

<h2>加氯计算部分</h2>
<p>（此部分未做任何改动）</p>

<textarea id="result_"></textarea>
<button onclick="copy_()">复制到剪贴板</button>

<hr>
@reichitose

<script>
// ====================== 微信水量识别（已修复） ======================
function readCpy() {
    const text = document.getElementById('hiddenTxt').value;
    if (!text) {
        alert('请先粘贴微信数据');
        return;
    }

    const p12 = /【\s*1[-－]2系\s*[:：]\s*(\d+)\s*】/;
    const p34 = /【\s*3[-－]4系\s*[:：]\s*(\d+)\s*】/;
    const p56 = /【\s*5[-－]6系\s*[:：]\s*(\d+)\s*】/;

    const m12 = text.match(p12);
    const m34 = text.match(p34);
    const m56 = text.match(p56);

    if (!m12 || !m34 || !m56) {
        alert('未识别到水量，请确认微信内容完整');
        return;
    }

    document.getElementById('12').value = m12[1];
    document.getElementById('34').value = m34[1];
    document.getElementById('56').value = m56[1];

    saveWaterData();
}

// ====================== 自动转存水量 ======================
function saveWaterData() {
    localStorage.setItem('water_data', JSON.stringify({
        ab: document.getElementById('12').value,
        cd: document.getElementById('34').value,
        ef: document.getElementById('56').value
    }));
}

window.addEventListener('load', function () {
    const data = JSON.parse(localStorage.getItem('water_data') || '{}');
    if (data.ab) document.getElementById('12').value = data.ab;
    if (data.cd) document.getElementById('34').value = data.cd;
    if (data.ef) document.getElementById('56').value = data.ef;
});

['12','34','56'].forEach(id => {
    document.getElementById(id).addEventListener('input', saveWaterData);
});

// ====================== 原有函数（未改） ======================
function clean() {
    document.getElementById('hiddenTxt').value = '';
}
function copy() {
    document.getElementById("result").select();
    document.execCommand('copy');
}
function copy_() {
    document.getElementById("result_").select();
    document.execCommand('copy');
}
</script>

</body>
</html>